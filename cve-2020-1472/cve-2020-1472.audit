# This script is Copyright (C) 2004-2020 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit addresses a temporary stop gap in targets where the patch is not installed or feasible to install in a timely manner.
#
# Sources for additional information:
#   https://www.tenable.com/blog/cve-2020-1472-zerologon-vulnerability-in-netlogon-could-allow-attackers-to-hijack-windows
#   https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc
#   https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472
#

<check_type:"Windows" version:"2">
<group_policy:"CVE-2020-1472">

<if>
  <condition type:"AND">
    <custom_item>
      type            : AUDIT_POWERSHELL
      description     : "Check that the target is an Active Directory controller"
      value_type      : POLICY_TEXT
      value_data      : "Pass"
      powershell_args : "$type=$((Get-WmiObject -Class Win32_OperatingSystem).ProductType); if($type -eq 2) { $result='Pass' } else { $result='Fail'}; $result"
    </custom_item>
  </condition>
  <then>
   <custom_item>
      type        : REGISTRY_SETTING
      description : "CVE-2020-1472 - FullSecureChannelProtection Registry Setting"
      info        : "The Netlogon Remote Protocol (also called MS-NRPC) is an RPC interface that is used exclusively by domain-joined devices. MS-NRPC includes an authentication method and a method of establishing a Netlogon secure channel. These updates enforce the specified Netlogon client behavior to use secure RPC with Netlogon secure channel between member computers and Active Directory (AD) domain controllers (DC).

This security update addresses the vulnerability by enforcing secure RPC when using the Netlogon secure channel in a phased release explained in the Updates section. To provide AD forest protection, all DCs, must be updated since they will enforce secure RPC with Netlogon secure channel. This includes read-only domain controllers (RODC).

To learn more about the vulnerability, see CVE-2020-1472 (https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472)."
      solution    : "From https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc#EnforcementMode

      The August 11, 2020 updates introduce the following registry setting to enable enforcement mode early. This will be enabled regardless of the registry setting in the Enforcement Phase starting on February 9, 2021:

      Registry subkey: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      Value: FullSecureChannelProtection
      Data type: REG_DWORD
      Data :
      1 - This enables enforcement mode. DCs will deny vulnerable Netlogon secure channel connections unless the account is allowed by the Create Vulnerable Connection list in the 'Domain controller: Allow vulnerable Netlogon secure channel connections' group policy.
      0 - DCs will allow vulnerable Netlogon secure channel connections from non-Windows devices. This option will be deprecated in the enforcement phase release.

      Reboot required?: No"
      see_also    : "https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc"
      value_type  : POLICY_DWORD
      value_data  : 1
      reg_key     : "HKLM\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters"
      reg_item    : "FullSecureChannelProtection"
      reg_option  : CAN_NOT_BE_NULL
    </custom_item>
  </then>
  <else>
    <report type: "PASSED">
      description : "CVE-2020-1472 - FullSecureChannelProtection Registry Setting"
      info        : "The target was not identified as a Domain Controller. This check is not applicable."
    </report>
  </else>
</if>

</group_policy>
</check_type>
